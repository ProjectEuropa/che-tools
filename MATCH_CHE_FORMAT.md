# match.CHE ファイルフォーマット解析

Carnage Heart EXA のマッチデータファイル（CEMD形式）の構造解析

## ファイル概要

| 項目 | 値 |
|------|-----|
| マジック | `CEMD` |
| ファイルサイズ | 266,232 bytes (0x40FF8) |
| 最大チーム数 | 16 |
| スロットサイズ | 832 bytes (0x340) |

## ファイル構造マップ

| 開始 | 終了 | サイズ | 内容 |
|------|------|--------|------|
| 0x00000 | 0x00070 | 112 | ヘッダー基本情報 |
| 0x00070 | 0x00120 | 176 | 初期化フラグ領域 (0x01パターン) |
| 0x00120 | 0x00148 | 40 | フィールド/モード設定 |
| 0x00148 | 0x00488 | 832 | 重複ヘッダー + パディング |
| 0x00488 | 0x03888 | 13,312 | チームスロット (16 x 832) |
| 0x03888 | 0x038BC | 52 | ゼロパディング / 勝敗データ領域 |
| 0x038BC | 0x3F1FC | 244,032 | OKEブロック (31 x 7,872) |
| 0x3F1FC | 0x40F00 | 7,428 | 追加OKEデータ領域 |
| 0x40F00 | 0x40F70 | 112 | フラグ領域 (0x01パターン) |
| 0x40F70 | 0x40F78 | 8 | フィールド/モードコピー |
| 0x40F78 | 0x40FF8 | 128 | フッター（フラグ + float）|

---

## ヘッダー領域 (0x000 - 0x487)

### 基本情報 (0x000 - 0x03F)

| オフセット | サイズ | 内容 | 例 |
|-----------|--------|------|-----|
| 0x000 | 4 | マジック | `CEMD` |
| 0x004 | 4 | ヘッダーサイズ | 0x148 (328) |
| 0x008 | 8 | バージョン文字列 | `0.0.44` |
| 0x010 | 8 | 予約領域（ゼロ） | |
| 0x018 | 24 | 大会名（Shift-JIS） | |
| 0x030 | 4 | パディング（0xCDCD...） | |
| 0x034 | 4 | チーム数 | 16 |
| 0x038 | 4 | マッチ数 | 29 |
| 0x03C | 4 | 不明（常に1?） | 1 |

### 対戦設定 (0x040 - 0x06F)

| オフセット | サイズ | 内容 | 例 |
|-----------|--------|------|-----|
| 0x040 | 4 | 不明（常に0?） | 0 |
| 0x044 | 4 | タイムリミット (float) | 540.0 |
| 0x048 | 4 | 不明 (float) | 120.0 |
| 0x04C | 4 | 不明 (float) | 1.0 |
| 0x050 | 4 | フラグ1 | 1 |
| 0x054 | 4 | フラグ2 | 0 |
| 0x058 | 4 | フラグ3 | 1 |
| 0x05C | 4 | フラグ4 | 1 |
| 0x060 | 4 | フラグ5 | 1 |
| 0x064 | 4 | フラグ6 | 1 |
| 0x068 | 8 | 予約（ゼロ） | |

### 対戦マトリクス領域 (0x070 - 0x11F)

176バイトの領域。各バイトが0x00または0x01の値を持つ。

- 先頭4バイト (0x070-0x073): 常に0x00
- 0x074-0x11B: 168バイト、全て0x01
- 最後4バイト (0x11C-0x11F): **実際はフィールド設定の一部**

**結論**: この領域は対戦可能フラグの配列と思われる。全て0x01なら全対戦有効。

**訂正**: 0x11C-0x11Fは次のセクション（フィールド設定）の開始位置

### フィールド・方式設定 (0x120 - 0x147)

| オフセット | サイズ | 内容 | 値 |
|-----------|--------|------|-----|
| 0x120 | 4 | 対戦フィールド | 下記参照 |
| 0x124 | 4 | 対戦方式 | 下記参照 |
| 0x128 | 32 | 予約（ゼロ） | |

#### 対戦フィールド値

| 値 | フィールド名 |
|----|-------------|
| 0 | 不明 |
| 3 | 上級演習所 |

#### 対戦方式値

| 値 | 方式 | マッチ数計算 |
|----|------|-------------|
| 12 (0x0C) | リーグ戦 | n(n-1)/2 |
| 25 (0x19) | ハーフリーグ | ≈n(n-1)/8 |

### 重複ヘッダー (0x148 - 0x18F)

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| 0x148 | 4 | 大会名サイズ（32） |
| 0x14C | 28 | 予約（ゼロ） |
| 0x168 | 24 | 大会名2 |
| 0x180 | 4 | パディング |
| 0x184 | 4 | チーム数2（0x034と同じ値） |
| 0x188 | 4 | マッチ数2（0x038と同じ値） |

**注意**: チーム数・マッチ数を変更する場合、0x034/0x038と0x184/0x188の両方を更新する必要がある

---

## チームスロット領域 (0x488 - 0x3547)

16スロット x 832バイト = 13,312バイト

### スロット位置

| Slot | 開始 | 終了 |
|------|------|------|
| 1 | 0x0488 | 0x07C7 |
| 2 | 0x07C8 | 0x0B07 |
| 3 | 0x0B08 | 0x0E47 |
| ... | ... | ... |
| 16 | 0x3548 | 0x3887 |

計算式: `slot_start = 0x488 + (slot_num - 1) * 832`

---

## スロット内部構造 (832 bytes)

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| 0x000-0x013 | 20 | チームアイコンビットマップ1（4bpp、40ピクセル分） |
| 0x014-0x053 | 64 | カラーパレット（16色 x 4バイト RGBA） |
| 0x054-0x06B | 24 | チーム名（Shift-JIS、NULL終端） |
| 0x06C-0x083 | 24 | オーナー名（Shift-JIS、NULL終端） |
| 0x084-0x0B3 | 48 | チームアイコンビットマップ2（続き、96ピクセル分） |
| 0x0B4-0x0B7 | 4 | チームID/登録順番号 |
| 0x0B8-0x0E7 | 48 | OKE 1 サマリーデータ |
| 0x0E8-0x117 | 48 | OKE 2 サマリーデータ |
| 0x118-0x147 | 48 | OKE 3 サマリーデータ |
| 0x148-0x33F | 504 | OKE ビットマップ（外見画像データ） |

**チームアイコンビットマップ (0x000-0x013 + 0x084-0x0B3):**
- 合計68バイト = 136ピクセル（4bpp）
- パターン例: 0x00（透明）、0x44（色4）、0xCC（色12）、0xFF（色15）
- チームごとに異なるアイコンデータ

### カラーパレット詳細 (0x014-0x053)

16色、各4バイト（R, G, B, A）

```
色0:  0x014-0x017
色1:  0x018-0x01B
...
色15: 0x050-0x053
```

### OKE サマリーデータ構造 (各48バイト)

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| +0x00 | 4 | **OKEブロックインデックス** |
| +0x04 | 4 | マジック `c8 e7 ac 08` |
| +0x08 | 4 | フラグ（通常 = 1） |
| +0x0C | 36 | 統計データ（対戦履歴？） |

**重要**: +0x00 フィールドがOKEブロックへの参照インデックス。
- スロット後のOKEブロック配列への0ベースインデックス
- team.CHE: 6, 7, 8 などのインデックス（新規割り当て用）
- match.CHE: 0-30の範囲で共有される（同じOKEが複数スロットで使用可能）
- 0xFFFFFFFF (-1): 未使用スロットを示す

### L3AR.CHE 全スロットのOKEインデックス

| Slot | OKE1 idx | OKE2 idx | OKE3 idx |
|------|----------|----------|----------|
| 0 | 8 | 0 | 7 |
| 1 | 4 | 3 | 5 |
| 2 | 7 | 6 | 8 |
| 3 | 4 | 3 | 2 |
| 4 | 8 | 0 | 4 |
| 5 | 4 | 5 | 3 |
| 6 | 4 | 3 | 5 |
| 7 | 6 | 8 | 1 |
| 8 | 7 | 6 | 8 |
| 9 | 2 | 7 | 3 |
| 10 | 7 | -1 | 8 |
| 11 | 6 | 7 | 8 |
| 12 | 6 | 3 | 7 |
| 13 | 0 | 2 | 1 |
| 14 | 3 | 7 | 8 |
| 15 | 6 | 8 | 7 |

**注意**: Slot 10 の OKE2 = -1 (0xFFFFFFFF) は未使用を示す

---

## スロット後領域 (0x3888以降) - OKEブロック領域

スロット領域の後に約250KB（251,708バイト）のOKEブロック領域が存在する。

| 領域 | オフセット | 内容 |
|------|-----------|------|
| ゼロ埋め | 0x3888-0x38BB | 52バイトのゼロ |
| OKEブロック | 0x38BC以降 | OKEブロックデータ（約31ブロック） |

### OKEブロック構造 (各7,872バイト)

**重要: 1ブロック = 1 OKE**（以前の「2ブロックペア」仮説は誤りだった）

各OKEブロックは独立しており、複数のスロットから参照可能（OKE共有）。

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| +0x0000 | 64 | OKEパレット（16色 x 4バイト） |
| +0x0040 | 64 | 統計データ（対戦履歴） |
| +0x0080 | 7188 | OKEビットマップデータ（外見画像） |
| +0x1C94 | 556 | OKEサマリー（名前、メタデータ） |

**注意:** match.CHEのOKEブロックには**AIプログラムコード全体は含まれない**。
表示用のサマリー情報（OKE名、パレット、ビットマップ）のみ格納される。

**ファイル内オフセット計算:**
```
OKE_BLOCK_START = 0x38BC
OKE_BLOCK_SIZE = 7872 (0x1EC0)

Block 0: 0x038BC - 0x0577B
Block 1: 0x0577C - 0x0763B
Block 2: 0x0763C - 0x094FB
...
Block 30: 0x3D33C - 0x3F1FB
```

### スロットとブロックの対応関係

OKEサマリーの **+0x00フィールド** がブロックインデックスを指定（+0x2Cではない）。

例（L3AR.CHE）:
| Slot | チーム名 | OKE1 idx | OKE2 idx | OKE3 idx |
|------|---------|----------|----------|----------|
| 0 | 朝雲v1.21B | 8 | 0 | 7 |
| 4 | 脱兎の如く・承 | 8 | 0 | 4 |
| 11 | アトラスLTS2 | 6 | 7 | 8 |

### team.CHE → match.CHE OKEブロック変換

| team.CHE OKE内 | match.CHE Block内 | 内容 |
|---------------|------------------|------|
| +0x230 (64B)  | +0x0000          | パレット |
| -             | +0x0040 (64B)    | 統計（テンプレート維持） |
| -             | +0x0080 (7188B)  | ビットマップ（テンプレート維持） |
| +0x000 (556B) | +0x1C94          | サマリー（OKE名、メタデータ） |

**注意:** AIプログラムコード（+0x2D0以降）はmatch.CHEには含まれない。

### OKEプログラムデータ構造（詳細）

OKEプログラムは7,872バイトで、以下の構造を持つ:

| オフセット | サイズ | 内容 | 備考 |
|-----------|--------|------|------|
| +0x000 | 24 | OKE名前（Shift-JIS） | 「アトラスＬＴＳ２」等 |
| +0x018 | 40 | パラメータ1 | 通常ゼロ |
| +0x040 | 64 | パラメータ2 | 通常ゼロ |
| +0x080 | 124 | 不明領域1 | 通常ゼロ |
| +0x0FC | 68 | OKEアイコンビットマップ | 0x30, 0x33パターン |
| +0x140 | 240 | 不明領域2 | 一部データあり |
| +0x230 | 64 | OKEパレット | 16色 x 4バイト |
| +0x270 | 96 | 統計/メタデータ | フラグ、数値等 |
| +0x2D0 | ~7000 | AIプログラムバイトコード | 実行コード |
| +0x1EB0 | 16 | フッター | フラグ（0x01等） |

**OKEアイコンビットマップ (+0x0FC):**
- 16x16ピクセル、4bpp（1ピクセル4ビット）
- パレットインデックス値 0x0-0xF
- 0x30, 0x33等のパターン（パレット色3を使用）

**OKEパレット (+0x230):**
```
色0:  40 40 40 FF  (グレー)
色1:  80 80 80 FF  (ライトグレー)
色2:  E4 E4 E4 FF  (ホワイト)
色3:  E4 1C 1C FF  (レッド)
...
```

---

## team.CHE との比較

| 項目 | match.CHE | team.CHE |
|------|-----------|----------|
| マジック | CEMD | CETD |
| ファイルサイズ | 266,232 bytes | 24,512 bytes |
| チーム数 | 最大16 | 1 |
| スロットサイズ | 832 bytes | N/A（全体が1チーム） |
| OKEプログラム | なし（サマリーのみ） | 含む（約6KB） |
| OKEビットマップ | あり（504 bytes） | なし |

### team.CHE 構造（参考）

| オフセット | 内容 |
|-----------|------|
| 0x240-0x27F | カラーパレット（16色 x 4バイト） |
| 0x280-0x297 | チーム名（24バイト） |
| 0x298-0x2AF | オーナー名（24バイト） |
| 0x2E4-0x313 | OKE 1 サマリー（48バイト） |
| 0x314-0x343 | OKE 2 サマリー（48バイト） |
| 0x344-0x373 | OKE 3 サマリー（48バイト） |
| 0x374以降 | OKE名前、プログラムデータ |

---

## 変換時の注意点

### team.CHE → match.CHE スロット変換

| match.CHE スロット | team.CHE | 備考 |
|-------------------|----------|------|
| 0x000-0x013 | なし | テンプレート使用 |
| 0x014-0x053 | 0x240-0x27F | カラーパレット |
| 0x054-0x06B | 0x280-0x297 | チーム名 |
| 0x06C-0x083 | 0x298-0x2AF | オーナー名 |
| 0x084-0x0B7 | なし | テンプレート使用 |
| 0x0B8-0x147 | なし | **OKEサマリーはテンプレート維持（重要）** |
| 0x148-0x33F | なし | **テンプレート使用（重要）** |

**重要**: OKEビットマップ（0x148-0x33F）はteam.CHEに存在しないため、テンプレートから継承する必要がある。各スロットのビットマップはそのスロット固有のものであり、別のスロットのビットマップを使用すると破損の原因となる。

---

## マッチファイル比較データ

複数のマッチファイルを解析した結果:

| ファイル | フィールド | 方式 | チーム数 | マッチ数 |
|----------|-----------|------|---------|---------|
| L3AR.CHE | 3 (上級演習所) | 25 (ハーフリーグ) | 16 | 29 |
| KISEI1.CHE | 3 (上級演習所) | 12 (リーグ) | 10 | 14 |
| match.CHE | 3 (上級演習所) | 12 (リーグ) | 15 | 22 |
| 1a.CHE | 3 (上級演習所) | 25 (ハーフリーグ) | 9 | 13 |

---

## L3AR.CHE 解析メモ

### 基本情報
- チーム数: 16
- マッチ数: 29
- team.CHE の「アトラスＬＴＳ２」はSlot 12に存在

### team.CHE との比較 (Slot 12)
| 項目 | 結果 |
|------|------|
| カラーパレット | 一致 |
| OKE1サマリー | 1バイト差分 (+0x2C) |
| OKE2サマリー | 1バイト差分 (+0x2C) |
| OKE3サマリー | 1バイト差分 (+0x2C) |
| ビットマップ | team.CHEには存在しない |

### OKEサマリーの差分
- `+0x2C` (44バイト目): 何らかのカウンターまたはフラグ
- L3AR.CHE: `0x13` (OKE1/2), `0x03` (OKE3)
- team.CHE: `0x00` (OKE1/2), `0x01` (OKE3)

### ビットマップパターン
各チームで異なるパターンを持つ：
- Slot 12 (アトラスＬＴＳ２): `0xcc`で埋まっている
- 他のスロット: `0x44`, `0x53`, `0xff`, `0x00`など様々

→ **ビットマップはチーム固有の機体外見画像データ**

---

## team.CHE 詳細構造

### ファイル概要

| 項目 | 値 |
|------|-----|
| マジック | `CETD` |
| ファイルサイズ | 24,512 bytes (0x5FC0) |
| OKE数 | 3 |

### ヘッダー構造

| オフセット | サイズ | 内容 | 例 |
|-----------|--------|------|-----|
| 0x000 | 4 | マジック | `CETD` |
| 0x004 | 4 | バージョン/サイズ | 0x1C |
| 0x008 | 4 | 不明 | 0x01 |
| 0x030 | 4 | OKE数 | 1 (実際は3だが固定値?) |

### 構造マップ

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| 0x000-0x00F | 16 | ヘッダー |
| 0x010-0x147 | 312 | 不明領域 |
| 0x148-0x17F | 56 | アイコンビットマップ1 |
| 0x180-0x237 | 184 | 追加ビットマップデータ |
| 0x238-0x277 | 64 | カラーパレット（16色） |
| 0x278-0x27F | 8 | パディング |
| 0x280-0x297 | 24 | チーム名（「アトラスＬＴＳ２」） |
| 0x298-0x2AF | 24 | オーナー名 |
| 0x2B0-0x2D7 | 40 | 不明領域 |
| 0x2D8-0x2E3 | 12 | 予約 |
| 0x2E4-0x313 | 48 | OKE 1 サマリー（Index=6） |
| 0x314-0x343 | 48 | OKE 2 サマリー（Index=7） |
| 0x344-0x373 | 48 | OKE 3 サマリー（Index=8） |
| 0x374-0x2233 | 7,872 | OKE 1 プログラムデータ |
| 0x2234-0x40F3 | 7,872 | OKE 2 プログラムデータ（0xCDパディング） |
| 0x40F4-0x5FB3 | 7,872 | OKE 3 プログラムデータ（0xCDパディング） |
| 0x5FB4-0x5FBF | 12 | フッター |

### OKEサマリー構造（team.CHE）

| オフセット | サイズ | 内容 | 例（OKE1） |
|-----------|--------|------|-----------|
| +0x00 | 4 | OKEインデックス | 6 |
| +0x04 | 4 | マジック | 0x08ACE7C8 |
| +0x08 | 4 | フラグ | 1 |
| +0x0C | 36 | ゼロパディング | |

### OKEプログラムデータ構造（OKE 1 @ 0x374）

| オフセット | サイズ | 内容 |
|-----------|--------|------|
| +0x000 | 16 | OKE名前（Shift-JIS）: 「アトラスＬＴＳ２」 |
| +0x010 | 16 | パラメータ（`0076 0076 0076...`） |
| +0x0FC | 64 | アイコンビットマップ（`30 33`パターン） |
| +0x230 | 64 | カラーパレット（16色） |
| +0x270 | 64 | 統計/メタデータ |
| +0x2D0 | ~7,000 | プログラムバイトコード |
| 末尾 | 27 | 0xCDパディング |

### team.CHE内のブランド名パターン

team.CHEにはOKE内に複数の機体名（ブランド）が格納されている：

| オフセット | 機体名 |
|-----------|--------|
| 0x1EE8 | ブランドR |
| 0x1FB2 | ブランドT |
| 0x2146 | ブランドX |
| 0x3DA8 | ブランドR（OKE2内） |
| 0x3E72 | ブランドT（OKE2内） |
| 0x4006 | ブランドX（OKE2内） |
| 0x5C68 | ブランドR（OKE3内） |
| 0x5D32 | ブランドT（OKE3内） |
| 0x5EC6 | ブランドX（OKE3内） |

これらは相対位置でOKE1内+0x1B74、+0x1C3E、+0x1DD2にある

---

## 制限事項・注意点

### ビットマップデータについて

team.CHEにはOKEビットマップ（機体外見画像）が含まれていない。match.CHEではスロット内の0x148-0x33F（504バイト）にビットマップが必要であるため、team.CHEからmatch.CHEへ変換する際はテンプレートのビットマップを使用する。

### 変換の重大な制限事項

**team.CHE → match.CHE変換の限界:**

| 項目 | コピー可否 | 理由 |
|------|----------|------|
| チーム名 | ○ | スロット内データ |
| オーナー名 | ○ | スロット内データ |
| カラーパレット | ○ | スロット内データ |
| OKEサマリー(+0x04以降) | ○ | マジック/フラグ |
| OKEサマリーインデックス | × | テンプレート維持必須 |
| OKEビットマップ | × | team.CHEに存在しない |
| OKEブロックデータ | × | 構造が完全に異なる |

**結果**:
- 変換後のチームは**テンプレートのOKE機体**を使用する
- team.CHEのプログラムコードは反映されない
- 対戦ロジックはOKEブロック内のデータで決まるため、外見と名前のみが反映される

**OKEブロック構造の違い:**

| 項目 | team.CHE OKEプログラム | match.CHE OKEブロック |
|------|----------------------|---------------------|
| サイズ | 7,872 bytes | 7,872 bytes |
| 先頭 | OKE名(Shift-JIS) | パレット(64 bytes) |
| +0x40 | パラメータ | 統計データ |
| +0x100 | プログラムコード | ビットマップ参照 |
| 用途 | AIロジック定義 | 表示/参照データ |

この違いにより、単純なコピーでは移植不可能だが、以下の方法で変換可能。

### OKEプログラムの格納方法（重要な発見）

**OKEプログラムは2ブロックにまたがって格納される：**

| 部分 | 位置 | サイズ |
|------|------|--------|
| Block N | +0x1C94 | 556 bytes (プログラム先頭) |
| Block N+1 | +0x0000 | 7316 bytes (プログラム残り) |

例: team.CHE「アトラスLTS2」のOKE1プログラム
- Block 18 +0x1C94: team_oke1[0:556]
- Block 19 +0x0000: team_oke1[556:7872]

**変換手順:**

1. **team.CHEからOKEプログラム抽出**
   - OKE1: 0x374 (7872 bytes)
   - OKE2: 0x2234 (7872 bytes)
   - OKE3: 0x40F4 (7872 bytes)

2. **OKEブロックペア作成 (各OKEにつき2ブロック)**
   - Block 2N:
     - +0x0000: パレット (64 bytes)
     - +0x0040: 統計 (64 bytes、初期値)
     - +0x0080: ビットマップ (7188 bytes)
     - +0x1C94: プログラム[0:556]
   - Block 2N+1:
     - +0x0000: プログラム[556:7872]

3. **スロットOKEサマリー更新**
   - +0x00: Block 2Nのインデックス
   - +0x04: マジック 0x08ACE7C8
   - +0x08: フラグ 1

**必要ブロック数:**
- 1チームあたり: 3 OKE × 2ブロック = 6ブロック
- 最大31ブロック → 5チーム（ブロック未共有時）
- ブロック共有により16チームまで対応可能

### 解明済み領域

| 領域 | 説明 |
|------|------|
| スロット 0xB4-0xB7 | Team ID。連番ではなく飛び飛びの値（0,1,2,3,4,7,10,11,...） |
| OKEサマリー +0x00 | **OKEブロックインデックス** - スロット後のOKEブロックへの参照番号（0-30、または-1=未使用） |
| OKEサマリー +0x04 | マジック定数 `0x08ACE7C8` - 全OKEで共通 |
| OKEサマリー +0x08 | フラグ（通常=1）- OKEが有効かどうか |
| 0x40F70-0x40F77 | ヘッダー0x120-0x127のコピー（フィールド値とモード値） |
| 0x40FE0-0x40FE3 | float値（対戦時間の合計？） |

### 重要な修正: OKEサマリー構造

以前 `+0x2C` がインデックスと推測されていたが、**実際は `+0x00` がインデックス**。

**team.CHE OKEサマリー (0x2E4):**
```
06 00 00 00  c8 e7 ac 08  01 00 00 00  00 00 00 00 ...
^---------^  ^---------^  ^---------^
  Index=6      Magic      Flag=1
```

**match.CHE スロットOKEサマリー (0x540):**
```
08 00 00 00  c8 e7 ac 08  01 00 00 00  00 00 00 00 ...
^---------^  ^---------^  ^---------^
  Index=8      Magic      Flag=1
```

### 未解明の領域

| 領域 | 説明 |
|------|------|
| スロット 0x00-0x13 | 用途不明。ゼロ埋め or 特定パターン（0x44, 0xcc, 0xffなど） |
| スロット 0x84-0xB3 | 一部にデータあり。ほとんどゼロ |
| 0x3888-0x38BB | 勝敗データ？ L3ARはゼロ、1aにはデータあり |
| 0x3F1FC-0x40F00 | 追加OKEデータ（91.7%がゼロ） |
| ヘッダー 0x070-0x11F | 初期化フラグ。先頭4バイト=0x00、残り172バイト=0x01 |

### テスト済み動作

- team.CHE読み込み → チーム名、カラーパレット、OKEサマリー正常取得
- match.CHE生成 → テンプレートベースで266,232バイトのCEMDファイル生成
- 変換シミュレーション → カラーパレット、チーム名、OKEサマリーの正確なコピーを確認

### OKEプログラム変換検証結果 (2025-12-08)

**test_converted.CHE 検証:**

| 検証項目 | 結果 | 詳細 |
|----------|------|------|
| OKE1プログラム先頭556バイト | ✓ 100%一致 | Block 0 +0x1C94 = team.CHE[0x374:0x374+556] |
| OKE1プログラム残り7316バイト | ✓ 100%一致 | Block 1 +0x0000 = team.CHE[0x374+556:0x374+7872] |
| OKE全体7872バイト | ✓ 100%一致 | 2ブロック結合データ完全一致 |
| スロットOKEサマリーインデックス | ✓ 更新済み | OKE1 → Block 0を参照 |
| ファイルサイズ | ✓ 正常 | 266,232バイト |
| マジック | ✓ CEMD | 正常なmatch.CHE形式 |

**OKE名確認:**
```
Block 0 +0x1C94: "アトラスＬＴＳ２ v v v"
```

**ブロック割り当て制限:**

| シナリオ | 対応チーム数 | 必要ブロック |
|----------|-------------|-------------|
| 全チーム3 OKE | 最大5チーム | 30/31ブロック |
| 全チーム2 OKE | 最大7チーム | 28/31ブロック |
| 全チーム1 OKE | 最大15チーム | 30/31ブロック |
| team.CHE (1有効OKE) | 最大15チーム | 30/31ブロック |

**無効OKE (0xCDパディング) の処理:**
- 自動スキップ → テンプレートのOKEインデックスを維持
- ブロック消費なし → 16チーム対応に貢献

---

## 更新履歴

- 2025-12-07: 初版作成
- 2025-12-07: L3AR.CHE解析メモ追加
- 2025-12-07: 対戦設定（フィールド、方式）の詳細を追加
- 2025-12-07: ヘッダー構造の詳細解析を追加
- 2025-12-07: マッチファイル比較データを追加
- 2025-12-07: team.CHE詳細構造を追加
- 2025-12-07: スロット後OKEプログラムデータ構造を追加
- 2025-12-07: スロット内0xB4-0xB7（チームID）を特定
- 2025-12-07: 制限事項・注意点セクションを追加
- 2025-12-08: **重要修正** OKEサマリーインデックスは+0x00（+0x2Cではない）
- 2025-12-08: 全スロットのOKEインデックステーブル追加
- 2025-12-08: team.CHE OKEプログラムデータ構造詳細追加
- 2025-12-08: team.CHE内ブランド名パターン発見
- 2025-12-08: che-parser.jsにOKEプログラム完全変換機能を実装
- 2025-12-08: OKEプログラム変換検証完了（100%バイト一致確認）
- 2025-12-08: OKEブロック構造詳細（2ブロックペア方式）を文書化
- 2025-12-08: OKEプログラム内部構造（パレット+0x230、ビットマップ+0x0FC等）を特定
- 2025-12-08: スロット内チームアイコンビットマップ領域（0x00-0x13 + 0x84-0xB3）を特定
- 2025-12-09: **重要修正** 2ブロックペア仮説は誤り。1ブロック=1OKE、AIコードは含まれない
- 2025-12-09: che-parser.js修正: OKEブロック上書き問題を解消
- 2025-12-10: team.CHE変換を最小化（パレット・名前・オーナーのみ、OKEサマリーはテンプレート維持）
- 2025-12-10: パレットオフセット確認: 0x240-0x27F（64バイト）が正しい
- 2025-12-11: **重要発見** SML.CHEテンプレートはSlot 0-1のみ有効、Slot 2以降は0xFFFFFFFF（無効）
- 2025-12-11: team.CHE配置時にOKEサマリーを初期化（無効スロットを有効化）
- 2025-12-11: **重要発見** SML.CHEのOKEブロック: Block 0-2のみ有効（ほのお/くさ/みずタイプ）、Block 3-30は空
- 2025-12-11: **修正** OKEインデックスを0,1,2に変更（6,7,8は空ブロックを参照していた）
- 2025-12-11: L3AR.CHE解析: 16チーム有効、Block 0-27に有効なOKE、Slot間でOKE共有
